const app = getApp();
const baseUrl = require('../utils/config.js')
const maintianInfo = {}; // 提交的数据
Page({
  StatusBar: app.globalData.StatusBar,
  CustomBar: app.globalData.CustomBar,
  /**
   * 页面的初始数据
   */
  data: {
    userInfo: {}, // 用户信息
    openid: '', // 唯一标识
    
    nowYear: '', // 年
    nowMonth: '', //月
    nowDay: '', //日
 
    // 故障类型
    fault: ['灯', '水龙头' ,'空调','电','热水','冷水'],
    // 图片
    imgList: [],
    // 日期
    dates: '',
    multiArray: [
      ['1栋', '2栋', '3栋', '4栋', '5栋'],
      ['1楼', '2楼', '3楼', '4楼', '5楼', '6楼', '7楼',],
      ['1201','1202','1203','1204','1205','1206','1207','1208','1209','1210',]
    ],
    objectMultiArray: [
      // 栋数
      [{
          id: 0,
          name: '1栋'
        },
        {
          id: 1,
          name: '2栋'
        },
        {
          id: 2,
          name: '3栋'
        },
        {
          id: 3,
          name: '4栋'
        },
        {
          id: 4,
          name: '5栋'
        },
      ],
      // 楼层
      [{
          id: 0,
          name: '1层'
        },
        {
          id: 1,
          name: '2层'
        },
        {
          id: 2,
          name: '3层'
        },
        {
          id: 3,
          name: '4层'
        },
        {
          id: 4,
          name: '5层'
        },
        {
          id: 5,
          name: '6层'
        },
        {
          id: 6,
          name: '7层'
        },
      ],
      // 宿舍号
      [{
          id: 0,
          name: '1201'
        },
        {
          id: 1,
          name: '1202'
        },
        {
          id: 2,
          name: '1203'
        },
        {
          id: 3,
          name: '1204'
        },
        {
          id: 4,
          name: '1205'
        },
        {
          id: 5,
          name: '1206'
        },
        {
          id: 6,
          name: '1207'
        },
        {
          id: 7,
          name: '1208'
        },
        {
          id: 8,
          name: '1209'
        },
        {
          id: 9,
          name: '1210'
        },
      ]
    ],
    multiIndex: [0, 0, 0],
    location: '1栋1楼1201' // 维修地点
  },


  // 选择宿舍楼
  dormitoryChange(e) {
    this.setData({
      index: e.detail.value
    })
  },
  // 选择宿舍号
  MultiChange(e) {
    this.setData({
      multiIndex: e.detail.value
    })
  },
  // 维修地点
  MultiColumnChange(e) {
    var that = this
    let data = {
      multiArray: this.data.multiArray,
      multiIndex: this.data.multiIndex
    };
    data.multiIndex[e.detail.column] = e.detail.value;
    switch (e.detail.column) {
      case 0:
        switch (data.multiIndex[0]) {
          case 0:
            data.multiArray[1] = ['1楼', '2楼', '3楼', '4楼', '5楼', '6楼', '7楼'];
            data.multiArray[2] = ['1101','1102','1103','1104','1105','1106','1107','1108','1109','1110',
                                  '2101','2102','2103','2104','2105','2106','2107','2108','2109','2110',
                                  '3101','3102','3103','3104','3105','3106','3107','3108','3109','3110'];
            break;
          case 1:
            data.multiArray[1] = ['1楼', '2楼', '3楼', '4楼', '5楼', '6楼', '7楼'];
            data.multiArray[2] = ['1101','1102','1103','1104','1105','1106','1107','1108','1109','1110',
            '2101','2102','2103','2104','2105','2106','2107','2108','2109','2110',
            '3101','3102','3103','3104','3105','3106','3107','3108','3109','3110'];
            break;
          case 2:
            data.multiArray[1] = ['1楼', '2楼', '3楼', '4楼', '5楼', '6楼', '7楼'];
            data.multiArray[2] = ['1101','1102','1103','1104','1105','1106','1107','1108','1109','1110',
            '2101','2102','2103','2104','2105','2106','2107','2108','2109','2110',
            '3101','3102','3103','3104','3105','3106','3107','3108','3109','3110'];
            break;
          case 3:
            data.multiArray[1] = ['1楼', '2楼', '3楼', '4楼', '5楼', '6楼', '7楼'];
            data.multiArray[2] = ['1101','1102','1103','1104','1105','1106','1107','1108','1109','1110',
            '2101','2102','2103','2104','2105','2106','2107','2108','2109','2110',
            '3101','3102','3103','3104','3105','3106','3107','3108','3109','3110'];
            break;
          case 4:
            data.multiArray[1] = ['1楼', '2楼', '3楼', '4楼', '5楼', '6楼', '7楼'];
            data.multiArray[2] = ['1101','1102','1103','1104','1105','1106','1107','1108','1109','1110',
            '2101','2102','2103','2104','2105','2106','2107','2108','2109','2110',
            '3101','3102','3103','3104','3105','3106','3107','3108','3109','3110'];
            break;

        }
        data.multiIndex[1] = 0;
        data.multiIndex[2] = 0;
        break;
      case 1:
        switch (data.multiIndex[0]) {
          case 0:
            switch (data.multiIndex[1]) {
              case 0:
                data.multiArray[2] = ['1101','1102','1103','1104','1105','1106','1107','1108','1109','1110',
                '2101','2102','2103','2104','2105','2106','2107','2108','2109','2110',
                '3101','3102','3103','3104','3105','3106','3107','3108','3109','3110'];
                break;
              case 1:
                data.multiArray[2] = ['1201','1202','1203','1204','1205','1206','1207','1208','1209','1210',
                '2201','2202','2203','2204','2205','2206','2207','2208','2209','2210',
                '3201','3202','3203','3204','3205','3206','3207','3208','3209','3210'];
                break;
              case 2:
                data.multiArray[2] = ['1301','1302','1303','1304','1305','1306','1307','1308','1309','1310',
                '2301','2302','2303','2304','2305','2306','2307','2308','2309','2310',
                '3301','3302','3303','3304','3305','3306','3307','3308','3309','3310'];
                break;
              case 3:
                data.multiArray[2] = ['1401','1402','1403','1404','1405','1406','1407','1408','1409','1410',
                '2401','2402','2403','2404','2405','2406','2407','2408','2409','2410',
                '3401','3402','3403','3404','3405','3406','3407','3408','3409','3410'];
                break;
              case 4:
                data.multiArray[2] = ['1501','1502','1503','1504','1505','1506','1507','1508','1509','1510',
                '2501','2502','2503','2504','2505','2506','2507','2508','2509','2510',
                '3501','3502','3503','3504','3505','3506','3507','3508','3509','3510'];
                break;
              case 5:
                data.multiArray[2] = ['1601','1602','1603','1604','1605','1606','1607','1608','1609','1610',
                '2601','2602','2603','2604','2605','2606','2607','2608','2609','2610',
                '3601','3602','3603','3604','3605','3606','3607','3608','3609','3610'];
              case 6:
                data.multiArray[2] = ['1701','1702','1703','1704','1705','1706','1707','1708','1709','1710',
                '2701','2702','2703','2704','2705','2706','2707','2708','2709','2710',
                '3701','3702','3703','3704','3705','3706','3707','3708','3709','3710'];
            }
            break;
          case 1:
            switch (data.multiIndex[1]) {
              case 0:
                data.multiArray[2] = ['1101','1102','1103','1104','1105','1106','1107','1108','1109','1110',
                '2101','2102','2103','2104','2105','2106','2107','2108','2109','2110',
                '3101','3102','3103','3104','3105','3106','3107','3108','3109','3110'];
                break;
              case 1:
                data.multiArray[2] = ['1201','1202','1203','1204','1205','1206','1207','1208','1209','1210',
                '2201','2202','2203','2204','2205','2206','2207','2208','2209','2210',
                '3201','3202','3203','3204','3205','3206','3207','3208','3209','3210'];
                break;
              case 2:
                data.multiArray[2] = ['1301','1302','1303','1304','1305','1306','1307','1308','1309','1310',
                '2301','2302','2303','2304','2305','2306','2307','2308','2309','2310',
                '3301','3302','3303','3304','3305','3306','3307','3308','3309','3310'];
                break;
              case 3:
                data.multiArray[2] = ['1401','1402','1403','1404','1405','1406','1407','1408','1409','1410',
                '2401','2402','2403','2404','2405','2406','2407','2408','2409','2410',
                '3401','3402','3403','3404','3405','3406','3407','3408','3409','3410'];
                break;
              case 4:
                data.multiArray[2] = ['1501','1502','1503','1504','1505','1506','1507','1508','1509','1510',
                '2501','2502','2503','2504','2505','2506','2507','2508','2509','2510',
                '3501','3502','3503','3504','3505','3506','3507','3508','3509','3510'];
                break;
              case 5:
                data.multiArray[2] = ['1601','1602','1603','1604','1605','1606','1607','1608','1609','1610',
                '2601','2602','2603','2604','2605','2606','2607','2608','2609','2610',
                '3601','3602','3603','3604','3605','3606','3607','3608','3609','3610'];
              case 6:
                data.multiArray[2] = ['1701','1702','1703','1704','1705','1706','1707','1708','1709','1710',
                '2701','2702','2703','2704','2705','2706','2707','2708','2709','2710',
                '3701','3702','3703','3704','3705','3706','3707','3708','3709','3710'];
            }
            break;
          case 2:
            switch (data.multiIndex[1]) {
                case 0:
                  data.multiArray[2] = ['1101','1102','1103','1104','1105','1106','1107','1108','1109','1110',
                  '2101','2102','2103','2104','2105','2106','2107','2108','2109','2110',
                  '3101','3102','3103','3104','3105','3106','3107','3108','3109','3110'];
                  break;
                case 1:
                  data.multiArray[2] = ['1201','1202','1203','1204','1205','1206','1207','1208','1209','1210',
                  '2201','2202','2203','2204','2205','2206','2207','2208','2209','2210',
                  '3201','3202','3203','3204','3205','3206','3207','3208','3209','3210'];
                  break;
                case 2:
                  data.multiArray[2] = ['1301','1302','1303','1304','1305','1306','1307','1308','1309','1310',
                  '2301','2302','2303','2304','2305','2306','2307','2308','2309','2310',
                  '3301','3302','3303','3304','3305','3306','3307','3308','3309','3310'];
                  break;
                case 3:
                  data.multiArray[2] = ['1401','1402','1403','1404','1405','1406','1407','1408','1409','1410',
                  '2401','2402','2403','2404','2405','2406','2407','2408','2409','2410',
                  '3401','3402','3403','3404','3405','3406','3407','3408','3409','3410'];
                  break;
                case 4:
                  data.multiArray[2] = ['1501','1502','1503','1504','1505','1506','1507','1508','1509','1510',
                  '2501','2502','2503','2504','2505','2506','2507','2508','2509','2510',
                  '3501','3502','3503','3504','3505','3506','3507','3508','3509','3510'];
                  break;
                case 5:
                  data.multiArray[2] = ['1601','1602','1603','1604','1605','1606','1607','1608','1609','1610',
                  '2601','2602','2603','2604','2605','2606','2607','2608','2609','2610',
                  '3601','3602','3603','3604','3605','3606','3607','3608','3609','3610'];
                case 6:
                  data.multiArray[2] = ['1701','1702','1703','1704','1705','1706','1707','1708','1709','1710',
                  '2701','2702','2703','2704','2705','2706','2707','2708','2709','2710',
                  '3701','3702','3703','3704','3705','3706','3707','3708','3709','3710'];
            }
            break;
          case 3:
            switch (data.multiIndex[1]) {
                  case 0:
                    data.multiArray[2] = ['1101','1102','1103','1104','1105','1106','1107','1108','1109','1110',
                    '2101','2102','2103','2104','2105','2106','2107','2108','2109','2110',
                    '3101','3102','3103','3104','3105','3106','3107','3108','3109','3110'];
                    break;
                  case 1:
                    data.multiArray[2] = ['1201','1202','1203','1204','1205','1206','1207','1208','1209','1210',
                    '2201','2202','2203','2204','2205','2206','2207','2208','2209','2210',
                    '3201','3202','3203','3204','3205','3206','3207','3208','3209','3210'];
                    break;
                  case 2:
                    data.multiArray[2] = ['1301','1302','1303','1304','1305','1306','1307','1308','1309','1310',
                    '2301','2302','2303','2304','2305','2306','2307','2308','2309','2310',
                    '3301','3302','3303','3304','3305','3306','3307','3308','3309','3310'];
                    break;
                  case 3:
                    data.multiArray[2] = ['1401','1402','1403','1404','1405','1406','1407','1408','1409','1410',
                    '2401','2402','2403','2404','2405','2406','2407','2408','2409','2410',
                    '3401','3402','3403','3404','3405','3406','3407','3408','3409','3410'];
                    break;
                  case 4:
                    data.multiArray[2] = ['1501','1502','1503','1504','1505','1506','1507','1508','1509','1510',
                    '2501','2502','2503','2504','2505','2506','2507','2508','2509','2510',
                    '3501','3502','3503','3504','3505','3506','3507','3508','3509','3510'];
                    break;
                  case 5:
                    data.multiArray[2] = ['1601','1602','1603','1604','1605','1606','1607','1608','1609','1610',
                    '2601','2602','2603','2604','2605','2606','2607','2608','2609','2610',
                    '3601','3602','3603','3604','3605','3606','3607','3608','3609','3610'];
                  case 6:
                    data.multiArray[2] = ['1701','1702','1703','1704','1705','1706','1707','1708','1709','1710',
                    '2701','2702','2703','2704','2705','2706','2707','2708','2709','2710',
                    '3701','3702','3703','3704','3705','3706','3707','3708','3709','3710'];
            }
            break;
          case 4:
            switch (data.multiIndex[1]) {
                  case 0:
                    data.multiArray[2] = ['1101','1102','1103','1104','1105','1106','1107','1108','1109','1110',
                    '2101','2102','2103','2104','2105','2106','2107','2108','2109','2110',
                    '3101','3102','3103','3104','3105','3106','3107','3108','3109','3110'];
                    break;
                  case 1:
                    data.multiArray[2] = ['1201','1202','1203','1204','1205','1206','1207','1208','1209','1210',
                    '2201','2202','2203','2204','2205','2206','2207','2208','2209','2210',
                    '3201','3202','3203','3204','3205','3206','3207','3208','3209','3210'];
                    break;
                  case 2:
                    data.multiArray[2] = ['1301','1302','1303','1304','1305','1306','1307','1308','1309','1310',
                    '2301','2302','2303','2304','2305','2306','2307','2308','2309','2310',
                    '3301','3302','3303','3304','3305','3306','3307','3308','3309','3310'];
                    break;
                  case 3:
                    data.multiArray[2] = ['1401','1402','1403','1404','1405','1406','1407','1408','1409','1410',
                    '2401','2402','2403','2404','2405','2406','2407','2408','2409','2410',
                    '3401','3402','3403','3404','3405','3406','3407','3408','3409','3410'];
                    break;
                  case 4:
                    data.multiArray[2] = ['1501','1502','1503','1504','1505','1506','1507','1508','1509','1510',
                    '2501','2502','2503','2504','2505','2506','2507','2508','2509','2510',
                    '3501','3502','3503','3504','3505','3506','3507','3508','3509','3510'];
                    break;
                  case 5:
                    data.multiArray[2] = ['1601','1602','1603','1604','1605','1606','1607','1608','1609','1610',
                    '2601','2602','2603','2604','2605','2606','2607','2608','2609','2610',
                    '3601','3602','3603','3604','3605','3606','3607','3608','3609','3610'];
                  case 6:
                    data.multiArray[2] = ['1701','1702','1703','1704','1705','1706','1707','1708','1709','1710',
                    '2701','2702','2703','2704','2705','2706','2707','2708','2709','2710',
                    '3701','3702','3703','3704','3705','3706','3707','3708','3709','3710'];
            }
            break;
        }
        data.multiIndex[2] = 0;
        break;
    }
    this.setData(data);
    // 获取用户选择的维修地点
    var location = '';
    // 维修点设置为用户的选择
    for(let i = 0; i < data.multiIndex.length; i++) {
      location += data.multiArray[i][data.multiIndex[i]]
    }
    that.setData({
      location: location
    })
  },
  // 故障类型
  faultType(e){
    this.setData({
      type: e.detail.value
    }) 
  },
  // 选择时间
  dateChange(e) {
    this.setData({
      dates: e.detail.value
    })
  },
   // 图片绑定事件
   ChooseImage() {
    wx.chooseImage({
      count: 4, //默认9
      sizeType: ['original', 'compressed'], //可以指定是原图还是压缩图，默认二者都有
      sourceType: ['album'], //从相册选择
      success: (res) => {
        if (this.data.imgList.length != 0) {
          this.setData({
            imgList: this.data.imgList.concat(res.tempFilePaths)
          })
        } else {
          this.setData({
            imgList: res.tempFilePaths
          })
        }
      },
      
    });
    
  },

  // 上传数据
  upload: function(){
    wx.uploadFile({
      filePath: this.data.imgList[0],
      name: 'fault_img',
      url: baseUrl + '/my/order/addmaintains',
      header: {
        "Content-Type": "multipart/form-data", //form-data格式
        "Authorization": this.data.userInfo.token
      },
      formData: maintianInfo,  
      
    })
  },

  ViewImage(e) {
    wx.previewImage({
      urls: this.data.imgList,  // 需要预览的图片链接列表
      current: e.currentTarget.dataset.url  // 当前显示图片的链接
    });
  },

  // 提交表单到数据库
  formSubmit(e) {
    var that = this
    let sub_date = that.data.nowYear + '-' + that.data.nowMonth + '-' + that.data.nowDay; // 提交日期
    maintianInfo.sub_date = sub_date, // 提交日期
    maintianInfo.phone_num = e.detail.value.phone_num, // 联系电话
    maintianInfo.repair_site = that.data.location, // 维修地点
    maintianInfo.fault_type = that.data.fault[e.detail.value.fault_type],  // 故障类型
    maintianInfo.repair_date = e.detail.value.repair_date,  // 预约维修日期
    maintianInfo.describe = e.detail.value.describe,  // 详情
    maintianInfo.state = '等待审核',  // 状态
    maintianInfo.openid = that.data.openid,  // 唯一标识
    that.upload()
    wx.request({
      url: baseUrl + '/my/order/addmaintains',
      method: 'POST',
      header: {
        
        contentType: false,
        // "Content-Type": "multipart/form-data", //form-data格式
        "Authorization": this.data.userInfo.token
      },
      data: maintianInfo,
      success: (res) => {
        console.log(res);
        if(res.data.status === 0) {
          wx.showToast({
            title: '提交成功',
          })
        } else if(maintianInfo.phone_num.length == 0) {
          wx.showToast({
            title: '请填写联系电话！',
            icon: 'none'
          })
        } else if(maintianInfo.repair_site.length == 0) {
          wx.showToast({
            title: '请选择维修地点',
            icon: 'none'
          })
        } else if(maintianInfo.fault_type.length ===0) {
          wx.showToast({
            title: '请选择故障类型',
            icon: 'none'
          })
        } else if(maintianInfo.repair_date.length === 0) {
          wx.showToast({
            title: '请选择预约维修时间',
            icon: 'none'
          })
        } else if(maintianInfo.describe.length === 0) {
          wx.showToast({
            title: '请描述故障信息',
            icon: 'none'
          })
        } else {
          wx.showToast({
            title: '提交成功',
            icon: "none"
          })
        }
      }
    })
    
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    let userInfo = wx.getStorageSync('userInfo')
    let openid = wx.getStorageSync('openid')
    if(userInfo) {
      this.setData({
        userInfo,
        openid
      })
    }

    // 时间
    var month = new Date().getMonth() + 1;
    var day = new Date().getDate();
    this.setData({
      nowYear: new Date().getFullYear(),
      nowMonth: month < 10 ? '0' + month : month,
      nowDay: day < 10 ? '0' + day : day
    })
  },

  
})